---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Admin - El Mundo del Celular">
  <main class="admin-page">
    <section class="admin-container">
      <div class="admin-header">
        <h1>Panel de Administraci√≥n</h1>
        <p>Agregar nuevos productos al cat√°logo</p>
      </div>

      <div class="form-container">
        <form id="productForm" class="product-form">
          <div class="form-group">
            <label for="nombre">Nombre del Producto</label>
            <input
              type="text"
              id="nombre"
              name="nombre"
              required
              placeholder="iPhone 15 Pro Max"
            />
          </div>

          <div class="form-group">
            <label for="descripcion">Descripci√≥n</label>
            <textarea
              id="descripcion"
              name="descripcion"
              rows="4"
              required
              placeholder="Describe las caracter√≠sticas principales del producto..."
            ></textarea>
          </div>

          <div class="form-group">
            <label for="precio">Precio (sin s√≠mbolos)</label>
            <input
              type="number"
              id="precio"
              name="precio"
              step="0.01"
              required
              placeholder="1299.99"
            />
          </div>

          <div class="form-group">
            <label for="imagen">Imagen del Producto</label>
            <div class="file-input-wrapper">
              <input
                type="file"
                id="imagen"
                name="imagen"
                accept="image/*"
                required
              />
              <div id="imagePreview" class="image-preview"></div>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-submit" id="submitBtn">
              <span class="btn-text">Agregar Producto</span>
              <span class="btn-loader" style="display: none;">‚è≥ Subiendo...</span>
            </button>
          </div>
        </form>

        <div id="message" class="message" style="display: none;"></div>
      </div>
    </section>
  </main>
</Layout>

<style>
  .admin-page {
    padding-top: 60px;
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }

  .admin-container {
    max-width: 700px;
    margin: 0 auto;
    padding: 3rem 2rem;
  }

  .admin-header {
    text-align: center;
    color: white;
    margin-bottom: 3rem;
    animation: fadeIn 0.8s ease-out;
  }

  .admin-header h1 {
    font-size: clamp(2rem, 4vw, 2.5rem);
    font-weight: 700;
    margin-bottom: 0.5rem;
  }

  .admin-header p {
    opacity: 0.95;
    font-size: 1.1rem;
  }

  .form-container {
    background: var(--color-surface);
    border-radius: 20px;
    padding: 2.5rem;
    box-shadow: var(--shadow-lg);
    animation: scaleIn 0.8s ease-out;
  }

  .product-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-group label {
    font-weight: 600;
    color: var(--color-text);
    font-size: 0.95rem;
  }

  .form-group input,
  .form-group textarea {
    padding: 1rem;
    border: 2px solid var(--color-border);
    border-radius: 12px;
    font-size: 1rem;
    font-family: var(--font-system);
    transition: all 0.3s;
    background: var(--color-bg);
  }

  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--color-accent);
    box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.1);
  }

  .form-group textarea {
    resize: vertical;
  }

  .file-input-wrapper {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .file-input-wrapper input[type="file"] {
    padding: 0.75rem;
    cursor: pointer;
  }

  .image-preview {
    min-height: 200px;
    border: 2px dashed var(--color-border);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-bg);
    overflow: hidden;
  }

  .image-preview img {
    max-width: 100%;
    max-height: 300px;
    object-fit: contain;
  }

  .image-preview.empty::after {
    content: 'üì∑ Vista previa de la imagen';
    color: #86868b;
    font-size: 1rem;
  }

  .form-actions {
    margin-top: 1rem;
  }

  .btn-submit {
    width: 100%;
    padding: 1.2rem;
    background: var(--color-accent);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .btn-submit:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 113, 227, 0.3);
  }

  .btn-submit:active:not(:disabled) {
    transform: translateY(0);
  }

  .btn-submit:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .message {
    margin-top: 1.5rem;
    padding: 1rem;
    border-radius: 12px;
    text-align: center;
    font-weight: 500;
    animation: fadeIn 0.3s ease-out;
  }

  .message.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .message.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }
</style>

<script>
  import { supabase } from '../lib/supabase';

  const form = document.getElementById('productForm') as HTMLFormElement;
  const imageInput = document.getElementById('imagen') as HTMLInputElement;
  const imagePreview = document.getElementById('imagePreview') as HTMLDivElement;
  const messageDiv = document.getElementById('message') as HTMLDivElement;
  const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;
  const btnText = submitBtn.querySelector('.btn-text') as HTMLSpanElement;
  const btnLoader = submitBtn.querySelector('.btn-loader') as HTMLSpanElement;

  // Preview de imagen
  imageInput.addEventListener('change', (e) => {
    const file = (e.target as HTMLInputElement).files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        imagePreview.innerHTML = `<img src="${e.target?.result}" alt="Preview" />`;
        imagePreview.classList.remove('empty');
      };
      reader.readAsDataURL(file);
    }
  });

  // Funci√≥n para mostrar mensajes
  function showMessage(text: string, type: 'success' | 'error') {
    messageDiv.textContent = text;
    messageDiv.className = `message ${type}`;
    messageDiv.style.display = 'block';
    
    setTimeout(() => {
      messageDiv.style.display = 'none';
    }, 5000);
  }

  // Funci√≥n para subir imagen a Supabase Storage
  async function uploadImage(file: File): Promise<string> {
    const fileExt = file.name.split('.').pop();
    const fileName = `${Math.random().toString(36).substring(2)}-${Date.now()}.${fileExt}`;
    const filePath = `${fileName}`;

    const { error } = await supabase.storage
      .from('productos')
      .upload(filePath, file);

    if (error) {
      throw new Error(`Error al subir imagen: ${error.message}`);
    }

    // Obtener URL p√∫blica
    const { data: publicData } = supabase.storage
      .from('productos')
      .getPublicUrl(filePath);

    return publicData.publicUrl;
  }

  // Env√≠o del formulario
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Deshabilitar bot√≥n
    submitBtn.disabled = true;
    btnText.style.display = 'none';
    btnLoader.style.display = 'inline';

    try {
      const formData = new FormData(form);
      const imageFile = imageInput.files?.[0];

      if (!imageFile) {
        throw new Error('Por favor selecciona una imagen');
      }

      // Subir imagen
      const imageUrl = await uploadImage(imageFile);

      // Insertar producto en la base de datos
      const { error } = await supabase
        .from('telefonos')
        .insert([
          {
            nombre: formData.get('nombre') as string,
            descripcion: formData.get('descripcion') as string,
            precio: parseFloat(formData.get('precio') as string),
            imagen_url: imageUrl,
          },
        ]);

      if (error) throw error;

      showMessage('‚úÖ Producto agregado exitosamente', 'success');
      form.reset();
      imagePreview.innerHTML = '';
      imagePreview.classList.add('empty');

    } catch (error) {
      console.error('Error:', error);
      showMessage(
        error instanceof Error ? error.message : 'Error al agregar producto',
        'error'
      );
    } finally {
      // Rehabilitar bot√≥n
      submitBtn.disabled = false;
      btnText.style.display = 'inline';
      btnLoader.style.display = 'none';
    }
  });
</script>
